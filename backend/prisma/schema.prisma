/// Prisma schema for the banking system.
///
/// This schema defines models for users, accounts, roles, transactions, and their relationships.
/// All table and field mappings use explicit naming for clarity and consistency with SQL schema.
/// Each model includes documentation to clarify purpose, relations, required fields, and special behaviors.
///
/// ATUALIZAÇÃO: As referências para operador de transação (operatorUserId, operator) foram removidas.
/// O campo operatorUserId permanece apenas como identificador livre (string), sem relação/fk para User.
/// O array "transactions" do User também foi removido.
/// Toda validação é feita exclusivamente no backend.
///
/// Para evitar erros de relacionamento, rode `prisma migrate dev` após salvar.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

//
// USERS
//
/// User model represents a system user.
/// Each user is uniquely identified and assigned a role.
/// Supports many-to-many associations with accounts.
///
/// ATENÇÃO: Não possui mais relação direta com transações (foi removida).
model User {
  /// User ID (UUID, primary key).
  id           String    @id @default(uuid()) @map("id_user")
  /// User name.
  name         String    @map("name")
  /// User email (unique).
  email        String    @unique @map("email")
  /// Hashed user password.
  password     String    @map("password")
  /// Foreign key to Role (required).
  roleId       String    @map("role_id")
  /// Role relationship; restrict deletion for DB integrity.
  role         Role      @relation(fields: [roleId], references: [id], onDelete: Restrict)
  /// Accounts associated to user (N:N via UserAccount).
  accounts     UserAccount[]
  /// Quando foi criado.
  createdAt    DateTime  @default(now()) @map("created_at")
  /// Última atualização.
  updatedAt    DateTime  @updatedAt @map("updated_at")
  @@map("user")
}

//
// ACCOUNT TYPE
//
/// AccountType defines distinct categories of accounts (e.g., Checking, Savings).
/// Each type has unique name, description, and is referenced by accounts.
model AccountType {
  /// Account type ID (UUID, primary key).
  id          String   @id @default(uuid()) @map("id_account_type")
  /// Unique account type name.
  name        String   @unique @map("name")
  /// Description of the account type.
  description String   @map("description")
  /// Accounts using this type.
  accounts    Account[]
  /// When the type was created.
  createdAt   DateTime @default(now()) @map("created_at")
  /// When the type was updated.
  updatedAt   DateTime @updatedAt @map("updated_at")
  @@map("account_type")
}

//
// ACCOUNT
//
/// Account model stores balance and indicates type/status.
/// Linked N:N to users via UserAccount.
/// Account type is required; status defaults to "ACTIVE".
model Account {
  /// Account ID (UUID, primary key).
  idAccount     String         @id @default(uuid()) @map("id_account")
  /// Account balance (defaults to 0).
  balance       Float          @default(0) @map("balance")
  /// Foreign key to AccountType (required).
  accountTypeId String         @map("account_type_id")
  /// Relation to account type.
  accountType   AccountType    @relation(fields: [accountTypeId], references: [id])
  /// Account status (defaults to "ACTIVE").
  status        String         @default("ACTIVE") @map("status")
  /// Users associated with account (N:N).
  users         UserAccount[]
  /// When the account was created.
  createdAt     DateTime       @default(now()) @map("created_at")
  /// When the account was updated.
  updatedAt     DateTime       @updatedAt @map("updated_at")
  @@map("account")
}

//
// USER ↔ ACCOUNT (N:N)
//
/// UserAccount links users and accounts in a many-to-many relationship.
/// Deletion or update cascades for both sides for DB integrity.
model UserAccount {
  /// Foreign key to Account.
  accountId String @map("account_id")
  /// Foreign key to User.
  userId    String @map("user_id")
  /// Relation to Account; cascades on delete/update.
  account Account @relation(fields: [accountId], references: [idAccount], onDelete: Cascade, onUpdate: Cascade)
  /// Relation to User; cascades on delete/update.
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  /// When the link was created.
  createdAt DateTime @default(now()) @map("created_at")
  /// When the link was updated.
  updatedAt DateTime @updatedAt @map("updated_at")
  @@id([accountId, userId])
  @@map("user_account")
}

//
// TRANSACTIONS
//
/// Transaction model logs account operations (deposit, withdrawal, transfer, etc.).
/// For transfer operations, two records will share the same transaction ID, but each will have a distinct type ("TRANSFER_IN" or "TRANSFER_OUT").
/// The composite key (idTransaction, type) is guaranteed unique, thus supporting paired/mirrored transfer records.
/// There is NO relation to user operator; the operatorUserId field is a free-form identifier.
/// visibleToAccountId is the UUID of the account for which the transaction is visible (mandatory, backend-only, must be set by business logic, never by client).
model Transaction {
  /// Transaction ID (UUID, can be shared between two records of a transfer).
  idTransaction        String    @map("id_transaction")
  /// Source account ID (nullable, transfer only).
  sourceAccountId      String?   @map("source_account_id")
  /// Destination account ID (nullable, transfer only).
  destinationAccountId String?   @map("destination_account_id")
  /// Type of transaction ("DEPOSIT", "WITHDRAW", "TRANSFER_IN", "TRANSFER_OUT").
  type                 String    @map("type")
  /// Transaction amount.
  amount               Float     @map("amount")
  /// Timestamp when transaction occurred.
  timestamp            DateTime  @default(now()) @map("timestamp")
  /// Balance before transaction.
  balanceBefore        Float     @map("balance_before")
  /// Balance after transaction.
  balanceAfter         Float     @map("balance_after")
  /// Operator user identifier (free-form, not a FK).
  operatorUserId       String?   @map("operator_user_id")
  /// Account for which the transaction is visible (mandatory, backend-only, never set from client).
  visibleToAccountId   String    @map("visible_to_account_id")
  /// Creation timestamp.
  createdAt            DateTime  @default(now()) @map("created_at")
  /// Last update timestamp.
  updatedAt            DateTime  @updatedAt @map("updated_at")

  @@id([idTransaction, type])
  @@map("transaction")
}

//
// ROLES
//
/// Role model represents user permission profiles (e.g., OWNER, ADMIN).
/// Used for RBAC across the system; referenced by users.
model Role {
  /// Role ID (UUID, primary key).
  id          String   @id @default(uuid()) @map("id")
  /// Unique role name ("OWNER", "ADMIN", etc.).
  name        String   @unique @map("name")
  /// Role description.
  description String   @map("description")
  /// Users assigned to this role.
  users       User[]
  /// When the role was created.
  createdAt   DateTime @default(now()) @map("created_at")
  /// When the role was updated.
  updatedAt   DateTime @updatedAt @map("updated_at")
  @@map("role")
}